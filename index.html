<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Walk Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 400px;
            grid-template-rows: 300px 300px;
            gap: 0;
            min-height: 600px;
        }

        .map-section {
            position: relative;
        }

        #map {
            width: 100%;
            height: 300px;
        }

        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        .map-btn {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            margin-left: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            color: #333;
            transition: all 0.2s;
        }

        .map-btn:hover {
            background: white;
            transform: translateY(-1px);
        }

        .map-btn:active {
            transform: translateY(0);
        }

        .streetview-section {
            position: relative;
            border-top: 1px solid #e9ecef;
        }

        #streetView {
            width: 100%;
            height: 300px;
        }

        .streetview-header {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            color: #333;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sidebar {
            padding: 30px;
            background: #f8f9fa;
            border-left: 1px solid #e9ecef;
            grid-row: 1 / 3;
            overflow-y: auto;
        }

        .progress-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .progress-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 25px;
            height: 12px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 25px;
            transition: width 0.8s ease;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .stat {
            text-align: center;
            padding: 15px;
            background: #f1f3f4;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .input-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #4facfe;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .route-info {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .route-info h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .route-details {
            font-size: 0.95em;
            color: #666;
            line-height: 1.6;
        }

        .walk-history {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }

        .walk-entry {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #4facfe;
            font-size: 0.9em;
        }

        .walk-entry:last-child {
            margin-bottom: 0;
        }

        .walk-date {
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 4px;
        }

        .walk-details {
            color: #666;
            line-height: 1.4;
        }

        .no-walks {
            color: #999;
            text-align: center;
            font-style: italic;
            margin: 0;
        }

        .location-info {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            max-height: 300px;
            overflow-y: auto;
        }

        .location-info h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .location-content {
            font-size: 0.9em;
            line-height: 1.5;
            color: #555;
        }

        .location-fact {
            background: #f8f9fa;
            border-left: 4px solid #4facfe;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .location-fact strong {
            color: #4facfe;
            display: block;
            margin-bottom: 4px;
        }

        .loading-location {
            color: #999;
            text-align: center;
            font-style: italic;
            margin: 20px 0;
        }

        .wiki-link {
            color: #4facfe;
            text-decoration: none;
            font-weight: 500;
        }

        .wiki-link:hover {
            text-decoration: underline;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
                grid-template-rows: 250px 250px auto;
            }
            
            .sidebar {
                border-left: none;
                border-top: 1px solid #e9ecef;
                grid-row: 3;
            }
            
            #map, #streetView {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö∂‚Äç‚ôÇÔ∏è Virtual Walk Challenge</h1>
            <p>Turn your daily walks into epic journeys!</p>
        </div>

        <div class="content">
            <div class="map-section">
                <div class="map-controls">
                    <button class="map-btn" onclick="showFullRoute()">üìç Full Route</button>
                    <button class="map-btn" onclick="zoomToCurrentLocation()">üîç My Location</button>
                </div>
                <div id="map"></div>
            </div>
            
            <div class="streetview-section">
                <div class="streetview-header">üìç Street View - Your Virtual Location</div>
                <div id="streetView"></div>
            </div>

            <div class="sidebar">
                <div class="input-section">
                    <h3>üó∫Ô∏è Route Setup</h3>
                    <div class="input-group">
                        <label for="startLocation">Start Location</label>
                        <input type="text" id="startLocation" placeholder="e.g., Delhi, India">
                    </div>
                    <div class="input-group">
                        <label for="endLocation">End Location</label>
                        <input type="text" id="endLocation" placeholder="e.g., Jaipur, India">
                    </div>
                    <button class="btn" onclick="createNewRoute()" style="margin-bottom: 20px;">Create New Route</button>
                    
                    <h3>üìä Log Your Walk</h3>
                    <div class="input-group">
                        <label for="distance">Distance Walked (km)</label>
                        <input type="number" id="distance" step="0.1" placeholder="e.g., 5.2">
                    </div>
                    <div class="input-group">
                        <label for="date">Date</label>
                        <input type="date" id="date">
                    </div>
                    <div class="input-group">
                        <label for="notes">Notes (optional)</label>
                        <input type="text" id="notes" placeholder="Morning jog, treadmill, etc.">
                    </div>
                    <button class="btn" onclick="addWalk()">Add Walk</button>
                </div>

                <div class="progress-card">
                    <h3>üéØ Progress</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-value" id="walkedDistance">0</div>
                            <div class="stat-label">km walked</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="remainingDistance">270</div>
                            <div class="stat-label">km remaining</div>
                        </div>
                    </div>
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-value" id="progressPercent">0%</div>
                            <div class="stat-label">complete</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="totalWalks">0</div>
                            <div class="stat-label">total walks</div>
                        </div>
                    </div>
                </div>

                <div class="input-section">
                    <h3>üìã Walk History</h3>
                    <div id="walkHistory" class="walk-history">
                        <p class="no-walks">No walks recorded yet. Add your first walk!</p>
                    </div>
                    <button class="btn" onclick="clearHistory()" style="background: #dc3545; margin-top: 10px;">Clear All History</button>
                </div>

                <div class="route-info">
                    <h3>üó∫Ô∏è Current Route</h3>
                    <div class="route-details">
                        <strong>Delhi to Jaipur</strong><br>
                        Distance: 270 km<br>
                        Famous route through Rajasthan<br><br>
                        <em>Current location:</em><br>
                        <span id="currentLocation">Starting in Delhi...</span>
                    </div>
                </div>

                <div class="location-info" id="locationInfo">
                    <h3>üìç Location Info</h3>
                    <div class="location-content" id="locationContent">
                        <p class="loading-location">üåç Discovering your virtual location...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // App data
        let walkData = {
            totalDistance: 0,
            walks: [],
            route: {
                name: "Delhi to Jaipur",
                totalKm: 270,
                start: { lat: 28.6139, lng: 77.2090 }, // Delhi
                end: { lat: 26.9124, lng: 75.7873 }    // Jaipur
            }
        };

        // Google Maps variables
        let map;
        let routePath;
        let currentMarker;
        let directionsService;
        let directionsRenderer;
        let streetViewPanorama;

        // Initialize the app
        function initApp() {
            // Set today's date as default
            document.getElementById('date').valueAsDate = new Date();
            
            // Load saved data first
            loadData();
            
            // Set route locations from saved data
            const routeName = walkData.route.name || "Delhi to Jaipur";
            const routeParts = routeName.split(' to ');
            
            if (routeParts.length === 2) {
                document.getElementById('startLocation').value = routeParts[0].trim();
                document.getElementById('endLocation').value = routeParts[1].trim();
            } else {
                // Fallback to defaults
                document.getElementById('startLocation').value = 'Delhi, India';
                document.getElementById('endLocation').value = 'Jaipur, India';
            }
            
            // Update display
            updateProgress();
            updateWalkHistory();
            
            // Initialize map
            initMap();
        }

        // Initialize Google Maps
        function initMap() {
            // Create map centered between Delhi and Jaipur
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 7,
                center: { lat: 27.76, lng: 76.45 },
                styles: [
                    {
                        "featureType": "water",
                        "elementType": "geometry",
                        "stylers": [{"color": "#e9e9e9"}, {"lightness": 17}]
                    },
                    {
                        "featureType": "landscape",
                        "elementType": "geometry",
                        "stylers": [{"color": "#f5f5f5"}, {"lightness": 20}]
                    }
                ]
            });

            // Initialize Street View
            streetViewPanorama = new google.maps.StreetViewPanorama(
                document.getElementById('streetView'),
                {
                    position: { lat: 28.6139, lng: 77.2090 }, // Default to Delhi
                    pov: { heading: 165, pitch: 0 },
                    zoom: 1,
                    addressControl: false,
                    showRoadLabels: true
                }
            );

            // Initialize directions service and renderer
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                strokeColor: '#4facfe',
                strokeWeight: 4,
                suppressMarkers: false
            });
            directionsRenderer.setMap(map);

            // Load the current route
            loadCurrentRoute();
        }

        // Create a new route
        function createNewRoute() {
            const startLocation = document.getElementById('startLocation').value.trim();
            const endLocation = document.getElementById('endLocation').value.trim();

            if (!startLocation || !endLocation) {
                alert('Please enter both start and end locations!');
                return;
            }

            if (startLocation === endLocation) {
                alert('Start and end locations cannot be the same!');
                return;
            }

            // Check if this is the same route as current one
            const newRouteName = `${startLocation} to ${endLocation}`;
            const currentRouteName = walkData.route.name;
            
            const isSameRoute = (
                newRouteName.toLowerCase() === currentRouteName.toLowerCase() ||
                (startLocation.toLowerCase() === currentRouteName.split(' to ')[0]?.toLowerCase().trim() &&
                 endLocation.toLowerCase() === currentRouteName.split(' to ')[1]?.toLowerCase().trim())
            );

            if (isSameRoute) {
                alert('This appears to be the same route you already have. No changes needed!');
                return;
            }

            // Ask user if they want to keep their walk data when switching routes
            const hasWalkData = walkData.walks.length > 0;
            let keepWalkData = false;

            if (hasWalkData) {
                keepWalkData = confirm(
                    `You have ${walkData.walks.length} walks recorded (${walkData.totalDistance.toFixed(1)} km).\n\n` +
                    `Do you want to KEEP this walk data for your new route?\n\n` +
                    `Click OK to KEEP your walks\n` +
                    `Click Cancel to START FRESH`
                );
            }

            // Show loading message
            const routeInfo = document.querySelector('.route-info .route-details');
            routeInfo.innerHTML = '<div class="loading">üó∫Ô∏è Creating route...</div>';

            // Clear any existing route first
            if (routePath) {
                routePath.setMap(null);
            }
            directionsRenderer.setDirections({routes: []});

            // Use Google Directions API to get route
            const request = {
                origin: startLocation,
                destination: endLocation,
                travelMode: google.maps.TravelMode.WALKING
            };

            directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    // Store old walk data if user wants to keep it
                    const oldWalks = keepWalkData ? [...walkData.walks] : [];
                    const oldDistance = keepWalkData ? walkData.totalDistance : 0;
                    
                    // Update route data
                    const route = result.routes[0];
                    const leg = route.legs[0];
                    
                    walkData.route = {
                        name: `${leg.start_address.split(',')[0]} to ${leg.end_address.split(',')[0]}`,
                        totalKm: parseFloat((leg.distance.value / 1000).toFixed(1)),
                        start: {
                            lat: leg.start_location.lat(),
                            lng: leg.start_location.lng()
                        },
                        end: {
                            lat: leg.end_location.lat(),
                            lng: leg.end_location.lng()
                        },
                        polyline: route.overview_polyline
                    };

                    // Restore walk data if user chose to keep it
                    if (keepWalkData) {
                        walkData.walks = oldWalks;
                        walkData.totalDistance = oldDistance;
                    } else {
                        walkData.walks = [];
                        walkData.totalDistance = 0;
                    }

                    // Display the route on map
                    directionsRenderer.setDirections(result);

                    // Center map on new route
                    map.fitBounds(result.routes[0].bounds);

                    // Save data and update displays
                    saveData();
                    updateProgress();
                    updateWalkHistory();
                    updateCurrentPosition();

                    const message = keepWalkData 
                        ? `‚úÖ Route updated!\n${walkData.route.name}\nDistance: ${walkData.route.totalKm} km\n\nYour ${oldWalks.length} walks (${oldDistance.toFixed(1)} km) have been kept!`
                        : `‚úÖ New route created!\n${walkData.route.name}\nDistance: ${walkData.route.totalKm} km`;
                    
                    alert(message);
                } else {
                    alert('Could not create route. Please check your locations and try again.\n\nTips:\n- Use specific addresses\n- Include city and country\n- Try "City, Country" format');
                    
                    // Restore route info
                    updateRouteInfo();
                }
            });
        }

        // Load current route on map
        function loadCurrentRoute() {
            // Always try to create a fresh route based on current route data
            const request = {
                origin: walkData.route.start,
                destination: walkData.route.end,
                travelMode: google.maps.TravelMode.WALKING
            };

            directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    
                    // Wait a bit for the route to be fully rendered, then update position
                    setTimeout(() => {
                        updateCurrentPosition();
                    }, 1000);
                } else {
                    console.log('Directions request failed due to ' + status);
                    // Fallback to simple polyline if directions fail
                    routePath = new google.maps.Polyline({
                        path: [walkData.route.start, walkData.route.end],
                        geodesic: true,
                        strokeColor: '#4facfe',
                        strokeOpacity: 1.0,
                        strokeWeight: 4
                    });
                    routePath.setMap(map);
                    updateCurrentPosition();
                }
            });
        }

        // Add a new walk
        function addWalk() {
            const distance = parseFloat(document.getElementById('distance').value);
            const date = document.getElementById('date').value;
            const notes = document.getElementById('notes').value.trim();

            if (!distance || !date) {
                alert('Please enter both distance and date!');
                return;
            }

            if (distance <= 0) {
                alert('Distance must be greater than 0!');
                return;
            }

            // Add walk to data
            const walkEntry = {
                distance: distance,
                date: date,
                notes: notes,
                timestamp: new Date().toISOString()
            };

            walkData.walks.unshift(walkEntry); // Add to beginning for newest first
            walkData.totalDistance += distance;

            // Save data
            saveData();

            // Update displays
            updateProgress();
            updateWalkHistory();
            updateCurrentPosition();

            // Clear inputs
            document.getElementById('distance').value = '';
            document.getElementById('notes').value = '';

            // Success feedback
            alert(`üéâ Great walk added!\n${distance} km on ${date}\nTotal distance: ${walkData.totalDistance.toFixed(1)} km`);
        }

        // Update walk history display
        function updateWalkHistory() {
            const historyDiv = document.getElementById('walkHistory');
            
            if (walkData.walks.length === 0) {
                historyDiv.innerHTML = '<p class="no-walks">No walks recorded yet. Add your first walk!</p>';
                return;
            }

            let historyHTML = '';
            walkData.walks.forEach((walk, index) => {
                const walkDate = new Date(walk.date).toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });

                historyHTML += `
                    <div class="walk-entry">
                        <div class="walk-date">${walkDate}</div>
                        <div class="walk-details">
                            <strong>${walk.distance} km</strong>
                            ${walk.notes ? `<br>üìù ${walk.notes}` : ''}
                        </div>
                    </div>
                `;
            });

            historyDiv.innerHTML = historyHTML;
        }

        // Clear walk history
        function clearHistory() {
            if (walkData.walks.length === 0) {
                alert('No walks to clear!');
                return;
            }

            if (confirm(`Are you sure you want to clear all ${walkData.walks.length} walks?\n\nThis cannot be undone!`)) {
                walkData.walks = [];
                walkData.totalDistance = 0;
                saveData();
                updateProgress();
                updateWalkHistory();
                updateCurrentPosition();
                alert('‚úÖ All walks cleared!');
            }
        }

        // Update progress display
        function updateProgress() {
            const progress = Math.min((walkData.totalDistance / walkData.route.totalKm) * 100, 100);
            const remaining = Math.max(walkData.route.totalKm - walkData.totalDistance, 0);

            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('walkedDistance').textContent = walkData.totalDistance.toFixed(1);
            document.getElementById('remainingDistance').textContent = remaining.toFixed(1);
            document.getElementById('progressPercent').textContent = progress.toFixed(1) + '%';
            document.getElementById('totalWalks').textContent = walkData.walks.length;

            // Update route info and location description
            updateRouteInfo();
        }

        // Update current position marker
        function updateCurrentPosition() {
            if (!map) return;

            const progress = Math.min(walkData.totalDistance / walkData.route.totalKm, 1);
            
            // Remove old marker
            if (currentMarker) {
                currentMarker.setMap(null);
            }

            let currentPosition;

            // Always try to use directions data for accurate positioning
            if (directionsRenderer.getDirections() && directionsRenderer.getDirections().routes.length > 0) {
                const route = directionsRenderer.getDirections().routes[0];
                const path = route.overview_path;
                
                if (path && path.length > 1) {
                    currentPosition = getPositionAlongPath(path, progress);
                } else {
                    // Fallback if path is not available
                    currentPosition = interpolatePosition(walkData.route.start, walkData.route.end, progress);
                }
            } else {
                // Fallback to simple calculation
                currentPosition = interpolatePosition(walkData.route.start, walkData.route.end, progress);
            }

            // Create the marker
            currentMarker = new google.maps.Marker({
                position: currentPosition,
                map: map,
                title: 'Your Current Virtual Location',
                icon: {
                    url: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="blue" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="m9 12 2 2 4-4"></path></svg>'),
                    scaledSize: new google.maps.Size(35, 35)
                },
                animation: google.maps.Animation.BOUNCE
            });

            // Zoom to current location for better context
            zoomToCurrentLocation(currentPosition);

            // Update Street View to current position
            updateStreetView(currentPosition);

            // Update location information
            updateLocationInfo(currentPosition);

            // Stop animation after 2 seconds
            setTimeout(() => {
                if (currentMarker) {
                    currentMarker.setAnimation(null);
                }
            }, 2000);
        }

        // Simple interpolation between two points
        function interpolatePosition(start, end, progress) {
            const lat = start.lat + (end.lat - start.lat) * progress;
            const lng = start.lng + (end.lng - start.lng) * progress;
            return { lat: lat, lng: lng };
        }

        // Zoom map to current location with appropriate zoom level
        function zoomToCurrentLocation(position) {
            if (!map) return;

            // If no position provided, use current marker position
            if (!position && currentMarker) {
                position = currentMarker.getPosition();
            }

            if (!position) return;

            // Determine zoom level based on route progress and total distance
            let zoomLevel;
            const routeDistance = walkData.route.totalKm;
            
            if (routeDistance > 1000) {
                // Very long routes (1000km+): City level zoom
                zoomLevel = 10;
            } else if (routeDistance > 500) {
                // Long routes (500-1000km): Regional zoom
                zoomLevel = 11;
            } else if (routeDistance > 200) {
                // Medium routes (200-500km): District level zoom
                zoomLevel = 12;
            } else if (routeDistance > 50) {
                // Short routes (50-200km): City district zoom
                zoomLevel = 13;
            } else {
                // Very short routes (<50km): Neighborhood zoom
                zoomLevel = 14;
            }

            // Smoothly pan and zoom to current position
            map.panTo(position);
            
            // Smooth zoom animation
            setTimeout(() => {
                map.setZoom(zoomLevel);
            }, 500);

            // Add a subtle animation effect to emphasize the location change
            if (currentMarker) {
                setTimeout(() => {
                    currentMarker.setAnimation(google.maps.Animation.BOUNCE);
                    setTimeout(() => {
                        currentMarker.setAnimation(null);
                    }, 1500);
                }, 800);
            }
        }

        // Show full route on map
        function showFullRoute() {
            if (!map || !directionsRenderer.getDirections()) return;

            // Fit map to show entire route
            const bounds = directionsRenderer.getDirections().routes[0].bounds;
            map.fitBounds(bounds);
            
            // Add some padding to the bounds
            setTimeout(() => {
                const currentZoom = map.getZoom();
                if (currentZoom > 0) {
                    map.setZoom(currentZoom - 1);
                }
            }, 500);
        }

        // Calculate position along the actual route path
        function getPositionAlongPath(path, progress) {
            if (!path || path.length === 0) return null;
            if (progress <= 0) return path[0];
            if (progress >= 1) return path[path.length - 1];

            try {
                // Calculate total path distance
                let totalDistance = 0;
                const distances = [0];
                
                for (let i = 0; i < path.length - 1; i++) {
                    const segmentDistance = google.maps.geometry.spherical.computeDistanceBetween(path[i], path[i + 1]);
                    totalDistance += segmentDistance;
                    distances.push(totalDistance);
                }

                // Find target distance
                const targetDistance = progress * totalDistance;

                // Find which segment contains our target point
                for (let i = 0; i < distances.length - 1; i++) {
                    if (targetDistance >= distances[i] && targetDistance <= distances[i + 1]) {
                        // Interpolate within this segment
                        const segmentProgress = (targetDistance - distances[i]) / (distances[i + 1] - distances[i]);
                        
                        return google.maps.geometry.spherical.interpolate(path[i], path[i + 1], segmentProgress);
                    }
                }

                return path[path.length - 1];
            } catch (error) {
                console.log('Error calculating position along path:', error);
                // Fallback to simple interpolation
                return interpolatePosition(path[0], path[path.length - 1], progress);
            }
        }

        // Update Street View to show current position
        function updateStreetView(position) {
            if (!streetViewPanorama || !position) return;

            // Create Street View service to check if imagery is available
            const streetViewService = new google.maps.StreetViewService();
            
            streetViewService.getPanorama({
                location: position,
                radius: 1000, // Search within 1km for street view imagery
                source: google.maps.StreetViewSource.OUTDOOR
            }, (data, status) => {
                if (status === 'OK') {
                    // Street View is available at this location
                    streetViewPanorama.setPano(data.location.pano);
                    streetViewPanorama.setPov({
                        heading: 270, // Face west by default
                        pitch: 0
                    });
                    streetViewPanorama.setZoom(1);
                    
                    // Update header to show we found street view
                    document.querySelector('.streetview-header').textContent = 
                        `üìç Street View - Your Virtual Location`;
                } else {
                    // No street view available, show a message
                    streetViewPanorama.setPosition(position);
                    document.querySelector('.streetview-header').textContent = 
                        `üìç No Street View Available - Remote Location`;
                }
            });
        }

        // Update location information with Wikipedia data
        function updateLocationInfo(position) {
            if (!position) return;

            const locationContent = document.getElementById('locationContent');
            locationContent.innerHTML = '<p class="loading-location">üîç Discovering local information...</p>';

            // Get location information
            Promise.all([
                getLocationName(position),
                getWikipediaInfo(position)
            ]).then(([locationName, wikiInfo]) => {
                let contentHTML = '';

                // Location name
                if (locationName) {
                    contentHTML += `<div class="location-fact"><strong>üìç You're virtually near:</strong>${locationName}</div>`;
                }

                // Wikipedia information
                if (wikiInfo && wikiInfo.length > 0) {
                    contentHTML += `<div class="location-fact"><strong>üìö Did you know?</strong>`;
                    wikiInfo.forEach(info => {
                        const snippet = info.extract ? info.extract.substring(0, 200) + '...' : 'Interesting location along your route.';
                        contentHTML += `
                            <div style="margin-top: 8px;">
                                <strong>${info.title}</strong><br>
                                ${snippet}
                                <a href="https://en.wikipedia.org/wiki/${info.title}" target="_blank" class="wiki-link">Read more ‚Üí</a>
                            </div>
                        `;
                    });
                    contentHTML += '</div>';
                } else {
                    contentHTML += '<div class="location-fact"><strong>üåç Exploring</strong>You\'re in a beautiful area! Keep walking to discover more interesting places along your route.</div>';
                }

                locationContent.innerHTML = contentHTML;

            }).catch(error => {
                console.log('Location info error:', error);
                locationContent.innerHTML = `
                    <div class="location-fact">
                        <strong>üåç Virtual Journey</strong>
                        You're making great progress on your route! Keep walking to discover new places.
                    </div>
                `;
            });
        }

        // Get location name from coordinates
        function getLocationName(position) {
            return new Promise((resolve) => {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ location: position }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const addressComponents = results[0].address_components;
                        let city = '';
                        let country = '';
                        
                        addressComponents.forEach(component => {
                            if (component.types.includes('locality') || component.types.includes('administrative_area_level_2')) {
                                city = component.long_name;
                            }
                            if (component.types.includes('country')) {
                                country = component.long_name;
                            }
                        });
                        
                        resolve(city ? `${city}, ${country}` : country);
                    } else {
                        resolve(null);
                    }
                });
            });
        }

        // Get Wikipedia information for location
        function getWikipediaInfo(position) {
            return new Promise((resolve) => {
                const lat = position.lat;
                const lng = position.lng;
                
                // Wikipedia API for nearby articles
                const wikiUrl = `https://en.wikipedia.org/api/rest_v1/page/nearby?lat=${lat}&lng=${lng}&radius=10000&limit=3`;
                
                fetch(wikiUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data.pages && data.pages.length > 0) {
                            // For multiple titles, we'll just take the first one for simplicity
                            const firstTitle = data.pages[0].title;
                            const summaryUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(firstTitle)}`;
                            
                            return fetch(summaryUrl);
                        } else {
                            resolve([]);
                        }
                    })
                    .then(response => response ? response.json() : null)
                    .then(summary => {
                        if (summary && !summary.type) {
                            resolve([{
                                title: summary.title,
                                extract: summary.extract
                            }]);
                        } else {
                            resolve([]);
                        }
                    })
                    .catch(error => {
                        console.log('Wikipedia API error:', error);
                        resolve([]);
                    });
            });
        }

        // Update location description
        function updateLocationDescription(progress) {
            let description;
            
            if (progress < 10) {
                description = `Just starting your journey from ${walkData.route.name.split(' to ')[0]}!`;
            } else if (progress < 25) {
                description = "Making good progress on your route...";
            } else if (progress < 50) {
                description = "Halfway there! Keep up the great work!";
            } else if (progress < 75) {
                description = "Getting close to your destination!";
            } else if (progress < 95) {
                description = "Almost there! You're doing amazing!";
            } else if (progress >= 100) {
                description = `üéâ Congratulations! You've reached ${walkData.route.name.split(' to ')[1]}!`;
            } else {
                description = "Approaching your destination...";
            }

            document.getElementById('currentLocation').textContent = description;
        }

        // Update route info display
        function updateRouteInfo() {
            const routeDetails = document.querySelector('.route-info .route-details');
            routeDetails.innerHTML = `
                <strong>${walkData.route.name}</strong><br>
                Distance: ${walkData.route.totalKm} km<br>
                Virtual journey route<br><br>
                <em>Current location:</em><br>
                <span id="currentLocation">Starting your journey...</span>
            `;
            
            // Update current location description
            const progress = (walkData.totalDistance / walkData.route.totalKm) * 100;
            updateLocationDescription(progress);
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('virtualWalkData', JSON.stringify(walkData));
        }

        // Load data from localStorage
        function loadData() {
            const saved = localStorage.getItem('virtualWalkData');
            if (saved) {
                const savedData = JSON.parse(saved);
                walkData.totalDistance = savedData.totalDistance || 0;
                walkData.walks = savedData.walks || [];
                // Keep route data if it exists
                if (savedData.route) {
                    walkData.route = savedData.route;
                }
            }
        }

        // Initialize app when page loads
        window.onload = initApp;
    </script>

    <!-- Google Maps API with your key -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAqRK8Qz1cHH_n6HSp5qc41pwvMCQiIj5k&libraries=geometry&callback=initMap">
    </script>
</body>
</html>
